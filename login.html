<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Login</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
    background-color:#1C1C1E;
    color:#f2f2f2;
    margin:0;
    padding:0;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
  }
  .box {
    background:#2A2A2D;
    border-radius:14px;
    padding:28px 26px 32px 26px;
    width:320px;
    box-shadow:0 4px 15px rgba(0,0,0,0.4);
    text-align:center;
  }
  .logo {
    background:#D81B60;
    color:white;
    font-weight:bold;
    font-size:1.6em;
    padding:10px 0;
    border-radius:50px;
    width:160px;
    margin:0 auto 15px auto;
    box-shadow:0 0 10px rgba(216,27,96,0.5);
  }
  .subtitle {font-size:1em;color:#aaa;margin-bottom:20px;}
  input, select {
    width:100%;padding:10px;margin:6px 0;
    border:none;border-radius:6px;
    background:#3A3A3D;color:#f2f2f2;
  }
  input::placeholder{color:#999;}
  button {
    width:100%;padding:10px;background:#D81B60;
    border:none;border-radius:6px;
    color:white;font-weight:bold;cursor:pointer;
    margin-top:10px;
  }
  button:hover{background:#E91E63;}
  .msg{margin-top:10px;color:rgb(0,200,0);}
  .err{margin-top:10px;color:rgb(255,80,80);}
</style>
</head>

<body>
  <div class="box">
    <div class="logo">MATBEO</div>
    <div class="subtitle">BEJELENTKEZÉS</div>
    <input id="user" placeholder="Felhasználó kód (pl. ABC)" autocomplete="username" />
    <input id="pwd" placeholder="Jelszó" type="password" autocomplete="current-password" inputmode="numeric" />
    <button id="btn">Bejelentkezés</button>

    <select id="empSelect" style="display:none;"></select>

    <div id="leaderPanel" style="display:none; margin-top:15px; background:#3A3A3D; padding:12px; border-radius:8px;">
      <div style="font-size:0.95em; color:#ccc;">Válaszd ki a dolgozót fentebb.</div>
    </div>

    <div id="out" class="msg"></div>
  </div>

<script>
function obfSimpleJS(s){
  const A="ABCDEFGHIJKLMNOPQRSTUVWXYZ", a="abcdefghijklmnopqrstuvwxyz";
  const revA=A.split("").reverse().join(""), reva=a.split("").reverse().join("");
  let out="";
  for(let ch of s){
    const iU=A.indexOf(ch), iL=a.indexOf(ch);
    if(iU!==-1) out+=revA[iU];
    else if(iL!==-1) out+=reva[iL];
    else if(/[0-9]/.test(ch)) out+=String(9-parseInt(ch));
    else out+=ch;
  }
  return out;
}

let userlist={};
async function loadUserlist(){
  try{
    const res=await fetch('userlist.json',{cache:"no-store"});
    if(!res.ok)throw 0;
    userlist=await res.json();
  }catch{ userlist={}; }
}
loadUserlist();

let logoutTimer;
function resetTimer(){
  clearTimeout(logoutTimer);
  logoutTimer=setTimeout(()=>{
    localStorage.removeItem('loggedUser');
    alert("Inaktivitás miatt automatikusan kilépett.");
    location.href='login.html';
  },10*60*1000);
}
['click','keydown','mousemove','touchstart'].forEach(e=>document.addEventListener(e,resetTimer));
resetTimer();

document.getElementById('btn').addEventListener('click', async ()=>{
  const u=document.getElementById('user').value.trim().toUpperCase();
  const p=document.getElementById('pwd').value.trim();
  const out=document.getElementById('out');
  const sel=document.getElementById('empSelect');
  if(!u||!p){out.className='err';out.textContent='Adj meg felhasználót és jelszót.';return;}
  if(Object.keys(userlist).length===0)await loadUserlist();
  const key=Object.keys(userlist).find(k=>k.toUpperCase()===u);
  if(!key){out.className='err';out.textContent='Felhasználónév nem jó!';return;}
  const d=userlist[key], obf=obfSimpleJS(p);
  if(d.pwd&&obf===d.pwd){
    out.className='msg'; out.textContent='BEJELENTKEZVE';
    localStorage.setItem('loggedUser',u);
    localStorage.removeItem('leaders');
    if(d.role===1){
      localStorage.setItem('leaders',JSON.stringify([u]));
      sel.style.display='block';
      document.getElementById('leaderPanel').style.display='block';
      sel.innerHTML='<option value="">Válaszd ki a dolgozót...</option>'+
        Object.keys(userlist).map(k=>`<option value="${k}">${k}</option>`).join('');
      sel.onchange=()=>{if(sel.value)openUserPage(sel.value)};
    }else{
      openUserPage(u);
    }
  }else{
    out.className='err';out.textContent='Jelszó nem jó!';
  }
});

async function openUserPage(emp){
  try{
    const baseAPI="https://api.github.com/repos/mobil-beo/matbeo/contents/HTML";
    const baseRAW="https://raw.githubusercontent.com/mobil-beo/matbeo/main/HTML/";
    const res=await fetch(baseAPI,{cache:"no-store"});
    if(!res.ok)throw 0;
    const files=await res.json();
    const f=files.find(x=>x.name.toUpperCase().startsWith(emp.toUpperCase()+"_")&&x.name.toLowerCase().endsWith(".html"));
    if(!f){alert("Nincs elérhető műsorod a GitHubon.");return;}
    const rawUrl=`${baseRAW}${f.name}`;
    // ✅ htmlpreview verzió, ami szépen rendereli
    const previewUrl=`https://htmlpreview.github.io/?${rawUrl}`;
    window.location.href=previewUrl;
  }catch{
    alert("Nem sikerült lekérni az adatokat a GitHubról.");
  }
}
</script>
</body>
</html>