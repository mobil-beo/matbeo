<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Login</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    background-color: #1C1C1E;
    color: #f2f2f2;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }
  .box {
    background: #2A2A2D;
    border-radius: 14px;
    padding: 28px 26px 32px 26px;
    width: 320px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    text-align: center;
  }
  .logo {
    background: #D81B60;
    color: white;
    font-weight: bold;
    font-size: 1.6em;
    padding: 10px 0;
    border-radius: 50px;
    width: 160px;
    margin: 0 auto 15px auto;
    box-shadow: 0 0 10px rgba(216,27,96,0.5);
  }
  .subtitle {
    font-size: 1em;
    color: #aaa;
    margin-bottom: 20px;
  }
  input, select {
    width: 100%;
    padding: 10px;
    margin: 6px 0;
    border: none;
    border-radius: 6px;
    background: #3A3A3D;
    color: #f2f2f2;
  }
  input::placeholder { color: #999; }
  button {
    width: 100%;
    padding: 10px;
    background: #D81B60;
    border: none;
    border-radius: 6px;
    color: white;
    font-weight: bold;
    cursor: pointer;
    margin-top: 10px;
  }
  button:hover { background: #E91E63; }
  .msg { margin-top: 10px; color: rgb(0,200,0); }
  .err { margin-top: 10px; color: rgb(255,80,80); }
</style>
</head>

<body>
  <div class="box">
    <div class="logo">MATBEO</div>
    <div class="subtitle">Jelentkezz be</div>
    <input id="user" placeholder="Felhasználó kód (pl. ABC)" autocomplete="username" />
    <input id="pwd" placeholder="Jelszó" type="password" autocomplete="current-password" inputmode="numeric" />
    <button id="btn">Bejelentkezés</button>
    <select id="empSelect" style="display:none;"></select>

    <!-- vezetői extra panel -->
    <div id="leaderPanel" style="display:none; margin-top:15px; background:#3A3A3D; padding:12px; border-radius:8px;">
      <div style="font-size:0.95em; color:#ccc;">
        Válaszd ki a dolgozót, akinek a napi feladatait meg szeretnéd tekinteni.
      </div>
    </div>

    <div id="out" class="msg"></div>
  </div>

<script>
// --- obfuszkáció ---
function obfSimpleJS(s) {
  const A = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  const a = "abcdefghijklmnopqrstuvwxyz";
  const revA = A.split("").reverse().join("");
  const reva = a.split("").reverse().join("");
  let out = "";
  for (let i = 0; i < s.length; i++) {
    const ch = s[i];
    const idxU = A.indexOf(ch);
    const idxL = a.indexOf(ch);
    if (idxU !== -1) out += revA[idxU];
    else if (idxL !== -1) out += reva[idxL];
    else if (/[0-9]/.test(ch)) out += String(9 - parseInt(ch, 10));
    else out += ch;
  }
  return out;
}

// --- userlist betöltése ---
let userlist = {};
async function loadUserlist() {
  try {
    const res = await fetch('userlist.json', {cache: "no-store"});
    if (!res.ok) throw new Error('userlist not found');
    userlist = await res.json();
  } catch (e) {
    console.warn('Nem sikerült betölteni a userlist.json-t:', e);
    userlist = {};
  }
}
loadUserlist();

// --- automatikus kijelentkezés 10 perc inaktivitás után ---
let logoutTimer;
function resetTimer() {
  clearTimeout(logoutTimer);
  logoutTimer = setTimeout(() => {
    localStorage.removeItem('loggedUser');
    alert("10 perc inaktivitás után automatikus kijelentkezés.");
    location.href = 'login.html';
  }, 10 * 60 * 1000);
}
['click','keydown','mousemove','touchstart'].forEach(e => document.addEventListener(e, resetTimer));
resetTimer();

// --- bejelentkezés logika ---
document.getElementById('btn').addEventListener('click', async function(){
  const u = document.getElementById('user').value.trim().toUpperCase();
  const p = document.getElementById('pwd').value.trim();
  const out = document.getElementById('out');
  const sel = document.getElementById('empSelect');
  if (!u || !p) { out.className='err'; out.textContent='Adj meg felhasználót és jelszót.'; return; }
  if (!userlist) await loadUserlist();
  const stored = userlist[u];
  if (!stored) { out.className='err'; out.textContent='Nincs ilyen felhasználó.'; return; }

  const obf = obfSimpleJS(p);
  if (obf === stored.pwd) {
    out.className = 'msg';
    out.textContent = 'Sikeres bejelentkezés — hozzáférés engedélyezve.';
    localStorage.setItem('loggedUser', u);
    const role = stored.role || 0;

    if (role === 1) {
      // --- VEZETŐ: dropdown + panel megjelenítése ---
      sel.style.display = 'block';
      document.getElementById('leaderPanel').style.display = 'block';
      sel.innerHTML = '<option value="">Válaszd ki a dolgozót...</option>' +
        Object.keys(userlist).map(k => `<option value="${k}">${k}</option>`).join('');
      sel.onchange = () => {
        const emp = sel.value;
        if (emp) openUserPage(emp);
      };
    } else {
      // --- NORMÁL DOLGOZÓ ---
      openUserPage(u);
    }
  } else {
    out.className='err'; out.textContent='Hibás jelszó.';
  }
});

async function openUserPage(emp) {
  try {
    //  Lekérjük a GitHub tartalmát (root könyvtár)
    const res = await fetch("https://api.github.com/repos/mobil-beo/matbeo/contents");
    const data = await res.json();

    //  Csak a napi mappákat nézzük, amik ilyenek: 15-OCT-2025
    const dateFolders = data
      .filter(item => /^[0-9]{2}-[A-Z]{3}-20[0-9]{2}$/.test(item.name))
      .map(item => item.name);

    if (dateFolders.length === 0) {
      alert("Nem található napi mappa a GitHubon.");
      return;
    }

    //  A legfrissebb mappa kiválasztása (ábécé szerint utolsó)
    const folder = dateFolders.sort().pop();

    //  Ellenőrizzük, van-e HTML az adott dolgozóhoz
    const target = `${folder}/${emp}_${folder}.html`;
    const check = await fetch(target);

    if (check.ok) {
      location.href = target;
    } else {
      alert("Nincs műsorod mára.");
    }

  } catch (e) {
    console.error(e);
    alert("Nem sikerült lekérni a napi adatokat.");
  }
}
</script>
</body>
</html>