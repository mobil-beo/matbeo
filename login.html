<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Login</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
    background-color:#1C1C1E;
    color:#f2f2f2;
    margin:0;
    padding:0;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
  }
  .box {
    background:#2A2A2D;
    border-radius:14px;
    padding:28px 26px 32px 26px;
    width:320px;
    box-shadow:0 4px 15px rgba(0,0,0,0.4);
    text-align:center;
  }
  .logo {
    background:#D81B60;
    color:white;
    font-weight:bold;
    font-size:1.6em;
    padding:10px 0;
    border-radius:50px;
    width:160px;
    margin:0 auto 15px auto;
    box-shadow:0 0 10px rgba(216,27,96,0.5);
  }
  .subtitle {font-size:1em;color:#aaa;margin-bottom:20px;}
  input, select {
    width:100%;padding:10px;margin:6px 0;
    border:none;border-radius:6px;
    background:#3A3A3D;color:#f2f2f2;
  }
  input::placeholder{color:#999;}
  button {
    width:100%;padding:10px;background:#D81B60;
    border:none;border-radius:6px;
    color:white;font-weight:bold;cursor:pointer;
    margin-top:10px;
  }
  button:hover{background:#E91E63;}
  .msg{margin-top:10px;color:rgb(0,200,0);}
  .err{margin-top:10px;color:rgb(255,80,80);}
</style>
</head>

<body>
  <div class="box">
    <div class="logo">MATBEO</div>
    <div class="subtitle">Jelentkezz be</div>
    <input id="user" placeholder="Felhaszn√°l√≥ k√≥d (pl. ABC)" autocomplete="username" />
    <input id="pwd" placeholder="Jelsz√≥" type="password" autocomplete="current-password" inputmode="numeric" />
    <button id="btn">Bejelentkez√©s</button>

    <select id="empSelect" style="display:none;"></select>

    <!-- vezet≈ëi extra panel -->
    <div id="leaderPanel" style="display:none; margin-top:15px; background:#3A3A3D; padding:12px; border-radius:8px;">
      <div style="font-size:0.95em; color:#ccc;">
        V√°laszd ki a dolgoz√≥t, akinek a napi feladatait meg szeretn√©d tekinteni.
      </div>
    </div>

    <div id="out" class="msg"></div>
  </div>

<script>
// --- obfuszk√°ci√≥ ---
function obfSimpleJS(s){
  const A="ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  const a="abcdefghijklmnopqrstuvwxyz";
  const revA=A.split("").reverse().join("");
  const reva=a.split("").reverse().join("");
  let out="";
  for(let i=0;i<s.length;i++){
    const ch=s[i];
    const idxU=A.indexOf(ch);
    const idxL=a.indexOf(ch);
    if(idxU!==-1)out+=revA[idxU];
    else if(idxL!==-1)out+=reva[idxL];
    else if(/[0-9]/.test(ch))out+=String(9-parseInt(ch,10));
    else out+=ch;
  }
  return out;
}

// --- userlist bet√∂lt√©se ---
let userlist={};
async function loadUserlist(){
  try{
    const res=await fetch('userlist.json',{cache:"no-store"});
    if(!res.ok)throw new Error('userlist not found');
    userlist=await res.json();
  }catch(e){
    console.warn('Nem siker√ºlt bet√∂lteni a userlist.json-t:',e);
    userlist={};
  }
}
loadUserlist();

// --- automatikus kijelentkez√©s 10 perc inaktivit√°s ut√°n ---
let logoutTimer;
function resetTimer(){
  clearTimeout(logoutTimer);
  logoutTimer=setTimeout(()=>{
    localStorage.removeItem('loggedUser');
    alert("10 perc inaktivit√°s ut√°n automatikus kijelentkez√©s.");
    location.href='login.html';
  },10*60*1000);
}
['click','keydown','mousemove','touchstart'].forEach(e=>document.addEventListener(e,resetTimer));
resetTimer();

// --- bejelentkez√©s logika ---
document.getElementById('btn').addEventListener('click', async function(){
  const rawUser=document.getElementById('user').value.trim();
  const u=rawUser.toUpperCase();
  const p=document.getElementById('pwd').value.trim();
  const out=document.getElementById('out');
  const sel=document.getElementById('empSelect');
  if(!u||!p){out.className='err';out.textContent='Adj meg felhaszn√°l√≥t √©s jelsz√≥t.';return;}
  if(!userlist||Object.keys(userlist).length===0)await loadUserlist();

  // kis/nagybet≈±f√ºggetlen keres√©s
  const userKey=Object.keys(userlist).find(k=>k.toUpperCase()===u);
  if(!userKey){out.className='err';out.textContent='Nincs ilyen felhaszn√°l√≥.';return;}

  const userData=userlist[userKey];
  const obf=obfSimpleJS(p);

  if(userData.pwd && obf===userData.pwd){
    out.className='msg';
    out.textContent='Sikeres bejelentkez√©s ‚Äî hozz√°f√©r√©s enged√©lyezve.';
    localStorage.setItem('loggedUser',u);
    const role=userData.role||0;

// üîπ mindig t√∂r√∂lj√ºk a kor√°bbi leaders list√°t, hogy ne maradjon benne r√©gi n√©v
localStorage.removeItem('leaders');

if(role===1){
  // üîπ VEZET≈ê: √∫j leaders lista l√©trehoz√°sa
  const leaders=[u];
  localStorage.setItem('leaders',JSON.stringify(leaders));

  // --- dropdown + panel ---
  sel.style.display='block';
  document.getElementById('leaderPanel').style.display='block';
  sel.innerHTML='<option value="">V√°laszd ki a dolgoz√≥t...</option>'+
    Object.keys(userlist).map(k=>`<option value="${k}">${k}</option>`).join('');
  sel.onchange=()=>{const emp=sel.value;if(emp)openUserPage(emp);};
}else{
  // üîπ NORM√ÅL DOLGOZ√ì
  openUserPage(u);
}
  }else{
    out.className='err';out.textContent='Hib√°s jelsz√≥.';
  }
});

async function openUserPage(emp){
  try{
    const res=await fetch("https://api.github.com/repos/mobil-beo/matbeo/contents");
    const data=await res.json();
    const dateFolders=data.filter(item=>/^[0-9]{2}-[A-Z]{3}-20[0-9]{2}$/.test(item.name)).map(item=>item.name);
    if(dateFolders.length===0){alert("Nem tal√°lhat√≥ napi mappa a GitHubon.");return;}
    const folder=dateFolders.sort().pop();
    const target=`${folder}/${emp}_${folder}.html`;
    const check=await fetch(target);
    if(check.ok){location.href=target;}
    else{alert("Nincs m≈±sorod m√°ra.");}
  }catch(e){
    console.error(e);
    alert("Nem siker√ºlt lek√©rni a napi adatokat.");
  }
}
</script>
</body>
</html>